import os
from dotenv import load_dotenv
from openai import AsyncOpenAI

load_dotenv()
client = AsyncOpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# –°—Ç–∞—Ä—ã–π –∞–Ω–∞–ª–∏–∑ (–æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /deep)
async def get_crypto_analysis(ticker):
    prompt = f"""
    –¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫—Ä–∏–ø—Ç–æ-–∞–Ω–∞–ª–∏—Ç–∏–∫. 
    –ü—Ä–æ–≤–µ–¥–∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã {ticker}.
    
    –¢–≤–æ–π –æ—Ç—á–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
    1. –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (Utility, Tokenomics, Risks).
    2. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ (Trends, Support/Resistance).
    3. –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑.
    
    –ò—Å–ø–æ–ª—å–∑—É–π –∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –∏ —ç–º–æ–¥–∑–∏. –û—Ç–≤–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
    """
    try:
        response = await client.chat.completions.create(
            model="gpt-4o-mini", # –ò–ª–∏ gpt-3.5-turbo
            messages=[{"role": "user", "content": prompt}]
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {str(e)}"

# –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–ù–ê–ô–ü–ï–†–°–ö–ò–ô –ê–ù–ê–õ–ò–ó
async def get_sniper_analysis(ticker, price):
    # –¢–≤–æ–π —à–∞–±–ª–æ–Ω –ø—Ä–æ–º–ø—Ç–∞
    system_prompt = f"""
    –¢—ã —ç–ª–∏—Ç–Ω—ã–π —Ç—Ä–µ–π–¥–µ—Ä —Å –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã –º–∞—Ä–∫–µ—Ç–º–µ–π–∫–µ—Ä–æ–º. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–Ω–µ—Ç—É {ticker} (–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: ${price}) –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏—è–º "–°–Ω–∞–π–ø–µ—Ä—Å–∫–æ–π —Å–¥–µ–ª–∫–∏".
    
    –¢–≤–æ—è —Ü–µ–ª—å: –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è —Å–Ω–∞–π–ø–µ—Ä—Å–∫–æ–π —Ñ—å—é—á–µ—Ä—Å–Ω–æ–π —Å–¥–µ–ª–∫–∏.
    
    –ò–°–ü–û–õ–¨–ó–£–ô –≠–¢–û–¢ –®–ê–ë–õ–û–ù –ê–ù–ê–õ–ò–ó–ê:
    
    1. –û–±—â–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ (–õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å, –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å).
    2. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ (–ü–∞—Ç—Ç–µ—Ä–Ω—ã 1H/4H, –£—Ä–æ–≤–Ω–∏, –û–±—ä–µ–º—ã, –°–≤–µ—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ü–∏–∏).
    3. –ê–Ω–∞–ª–∏–∑ –õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ (–ó–æ–Ω—ã —Å—Ç–æ–ø–æ–≤, –°–±–æ—Ä—ã –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏).
    4. –î–µ–π—Å—Ç–≤–∏—è –ú–∞—Ä–∫–µ—Ç–º–µ–π–∫–µ—Ä–∞ (–ê–∫–∫—É–º—É–ª—è—Ü–∏—è, –°–ø—É—Ñ–∏–Ω–≥, –û—Ö–æ—Ç–∞ –∑–∞ —Å—Ç–æ–ø–∞–º–∏).
    5. –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª (–ö—Ä–∞—Ç–∫–æ).
    
    –§–û–†–ú–ê–¢ –í–´–í–û–î–ê (–°—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É Markdown –¥–ª—è Telegram):
    
    üéØ **–°–ù–ê–ô–ü–ï–†–°–ö–ò–ô –ê–ù–ê–õ–ò–ó: {ticker}**
    üíµ –¶–µ–Ω–∞: ${price}
    
    üß± **–ö–ª—é—á–µ–≤—ã–µ –£—Ä–æ–≤–Ω–∏:**
    ‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞: ...
    ‚Ä¢ –°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ: ...
    
    üìä **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π & MM –ê–Ω–∞–ª–∏–∑:**
    [–¢—É—Ç –æ–ø–∏—à–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏–º–ø—É–ª—å—Å—É, –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ —Å–ª–µ–¥—ã –º–∞—Ä–∫–µ—Ç–º–µ–π–∫–µ—Ä–∞]
    
    üêã **–°–ª–µ–¥—ã –ö—Ä—É–ø–Ω–æ–≥–æ –ò–≥—Ä–æ–∫–∞:**
    [–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ Liquidity Hunter, Accumulation –∏ –¥—Ä.]
    
    üö¶ **–§–¨–Æ–ß–ï–†–°–ù–´–ô –°–ò–ì–ù–ê–õ:**
    –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: **[–õ–û–ù–ì / –®–û–†–¢ / –ù–ï–í–•–û–î]** (–í—ã–±–µ—Ä–∏ –æ–¥–Ω–æ)
    
    üìç **–í—Ö–æ–¥:** [–î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω—ã]
    
    ‚úÖ **–¢–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç—ã:**
    1. TP1: ...
    2. TP2: ...
    3. TP3: ...
    
    üõ° **–£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ:**
    1. ...
    2. ...
    
    ‚õîÔ∏è **–°—Ç–æ–ø-–ª–æ—Å—Å:** ...
    
    *–î–∏—Å–∫–ª–µ–π–º–µ—Ä: –ù–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å–æ–≤–µ—Ç. –°–æ–±–ª—é–¥–∞–π—Ç–µ —Ä–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç.*
    """

    try:
        response = await client.chat.completions.create(
            model="gpt-4o-mini", # –≠—Ç–æ—Ç —à–∞–±–ª–æ–Ω —Å–ª–æ–∂–Ω—ã–π, gpt-4o-mini —Å–ø—Ä–∞–≤–∏—Ç—Å—è –ª—É—á—à–µ
            messages=[
                {"role": "system", "content": "–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–π–¥–µ—Ä."},
                {"role": "user", "content": system_prompt}
            ]
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–Ω–∞–π–ø–µ—Ä-–∞–Ω–∞–ª–∏–∑–∞: {str(e)}"