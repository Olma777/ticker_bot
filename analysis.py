import os
from dotenv import load_dotenv
from openai import AsyncOpenAI

load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ OpenRouter
client = AsyncOpenAI(
    api_key=os.getenv("OPENAI_API_KEY"),
    base_url="https://openrouter.ai/api/v1"
)

# –ò—Å–ø–æ–ª—å–∑—É–µ–º DeepSeek V3 (–æ–Ω –∏–¥–µ–∞–ª–µ–Ω –¥–ª—è —Ç–∞–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞)
MODEL_NAME = "deepseek/deepseek-chat"

# --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: SWING / DEEP ANALYSIS (–¢–≤–æ–π –Ω–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç) ---
async def get_crypto_analysis(ticker):
    system_prompt = f"""
    –¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–≤–∏–Ω–≥-—Ç—Ä–µ–π–¥–µ—Ä –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫ –º–∞—Ä–∫–µ—Ç–º–µ–π–∫–µ—Ä—Å–∫–∏—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π.
    –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–≤–µ—Å—Ç–∏ –≥–ª—É–±–æ–∫–∏–π —Å—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –º–æ–Ω–µ—Ç—ã {ticker}.
    
    –°–õ–ï–î–£–ô –≠–¢–û–ú–£ –ê–õ–ì–û–†–ò–¢–ú–£ –°–¢–†–û–ì–û:

    1. –ö–ª—é—á–µ–≤—ã–µ —É—Ä–æ–≤–Ω–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è (Daily/Weekly):
       - –£–∫–∞–∂–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ, –Ω–∞–∏–±–æ–ª–µ–µ —Å–∏–ª—å–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ (–≥—Ä–∞–Ω–∏—Ü—ã –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤).

    2. –¢–µ–∫—É—â–∞—è —Ñ–∞–∑–∞ —Ä—ã–Ω–∫–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç—Ä–µ–Ω–¥–∞:
       - –§–∞–∑–∞: –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ, –ë—ã—á–∏–π —Ç—Ä–µ–Ω–¥, –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–ª–∏ –ú–µ–¥–≤–µ–∂–∏–π —Ç—Ä–µ–Ω–¥.
       - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –ö–∞–Ω–∞–ª, –∫–ª–∏–Ω, –±–æ–∫–æ–≤–∏–∫ –∏ —Ç.–¥.

    3. –ê–Ω–∞–ª–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ –¥–µ–π—Å—Ç–≤–∏–π –∫—Ä—É–ø–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤:
       - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã: OI, Funding Rates, Long/Short ratio. –ï—Å—Ç—å –ª–∏ –¥–∏—Å–±–∞–ª–∞–Ω—Å –¥–ª—è —Å–∫–≤–∏–∑–∞?
       - –î–µ–π—Å—Ç–≤–∏—è –ú–∞—Ä–∫–µ—Ç–º–µ–π–∫–µ—Ä–∞:
         * –ê–∫–∫—É–º—É–ª—è—Ü–∏—è/–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (—Å–∫—Ä—ã—Ç—ã–π –Ω–∞–±–æ—Ä/—Å–±—Ä–æ—Å).
         * "Liquidity Hunter": –ì–¥–µ —Å–∫–æ–ø–ª–µ–Ω–∏—è —Å—Ç–æ–ø–æ–≤?
         * "Spoofing/Layering": –ï—Å—Ç—å –ª–∏ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ —Å—Ç–µ–Ω–∞–º–∏ –æ—Ä–¥–µ—Ä–æ–≤?

    4. –§—å—é—á–µ—Ä—Å–Ω—ã–π —Å–∏–≥–Ω–∞–ª (–°–≤–∏–Ω–≥-–ø–æ–∑–∏—Ü–∏—è):
       - –¢–û–õ–¨–ö–û –û–î–ù–û –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ï (–õ–û–ù–ì –∏–ª–∏ –®–û–†–¢).
       - –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (–æ—Ç—Å–∫–æ–∫ –∏–ª–∏ –ø—Ä–æ–±–æ–π).
       - 3 –¢–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç–∞.
       - –£—Ä–æ–≤–Ω–∏ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è.
       - –°—Ç–æ–ø-–ª–æ—Å—Å (–æ—Ç–º–µ–Ω–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è).

    –§–û–†–ú–ê–¢ –í–´–í–û–î–ê (Markdown –¥–ª—è Telegram):
    
    üåä **SWING ANALYSIS: {ticker}**
    
    üß± **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –£—Ä–æ–≤–Ω–∏:**
    ‚Ä¢ –§–∞–∑–∞ —Ä—ã–Ω–∫–∞: ...
    ‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ (D/W): ...
    ‚Ä¢ –°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ (D/W): ...
    
    üêã **–°–ª–µ–¥—ã –ú–∞—Ä–∫–µ—Ç–º–µ–π–∫–µ—Ä–∞:**
    [–ê–Ω–∞–ª–∏–∑ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏, OI, —Ñ–∞–Ω–¥–∏–Ω–≥–∞ –∏ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π]
    
    üîÆ **–°—Ü–µ–Ω–∞—Ä–∏–π –¥–≤–∏–∂–µ–Ω–∏—è:**
    [–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –≤—Ö–æ–¥–∞]
    
    üö¶ **–°–ò–ì–ù–ê–õ: [–õ–û–ù–ì / –®–û–†–¢]**
    üìç **–í—Ö–æ–¥:** ...
    
    ‚úÖ **–¢–µ–π–∫–∏:**
    1. ...
    2. ...
    3. ...
    
    üõ° **–£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ:**
    1. ...
    2. ...
    
    ‚õîÔ∏è **–°—Ç–æ–ø-–ª–æ—Å—Å:** ...
    
    *–î–∏—Å–∫–ª–µ–π–º–µ—Ä: –°–æ–±–ª—é–¥–∞–π—Ç–µ —Ä–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç.*
    """

    try:
        response = await client.chat.completions.create(
            model=MODEL_NAME,
            messages=[
                {"role": "system", "content": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É –∞–Ω–∞–ª–∏–∑—É –∏ Smart Money Concepts."},
                {"role": "user", "content": system_prompt}
            ],
            extra_headers={
                "HTTP-Referer": "https://telegram.org",
                "X-Title": "CryptoBot"
            }
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {str(e)}"


# --- –§–£–ù–ö–¶–ò–Ø SNIPER (–û—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å, –æ–Ω–∞ –¥–ª—è —Å–∫–∞–ª—å–ø–∏–Ω–≥–∞) ---
async def get_sniper_analysis(ticker, price):
    system_prompt = f"""
    –¢—ã —ç–ª–∏—Ç–Ω—ã–π —Å–∫–∞–ª—å–ø–µ—Ä. –ü—Ä–æ–≤–µ—Ä—å –º–æ–Ω–µ—Ç—É {ticker} (–¶–µ–Ω–∞: ${price}) –Ω–∞ —Å–Ω–∞–π–ø–µ—Ä—Å–∫–∏–π –≤—Ö–æ–¥.
    
    –§–û–†–ú–ê–¢ –í–´–í–û–î–ê (Markdown):
    üéØ **–°–ù–ê–ô–ü–ï–†-–°–ï–¢–ê–ü: {ticker}**
    üíµ –¶–µ–Ω–∞: ${price}
    
    üìä **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∏–Ω–∞:**
    [–ü–∞—Ç—Ç–µ—Ä–Ω—ã 1H/4H, –æ–±—ä–µ–º—ã, —Å—Ç–∞–∫–∞–Ω]
    
    üö¶ **–°–ò–ì–ù–ê–õ:** [–õ–û–ù–ì / –®–û–†–¢ / –ñ–î–ê–¢–¨]
    üìç –í—Ö–æ–¥: ...
    ‚úÖ –¢–µ–π–∫–∏: TP1, TP2, TP3
    ‚õîÔ∏è –°—Ç–æ–ø: ...
    """

    try:
        response = await client.chat.completions.create(
            model=MODEL_NAME,
            messages=[
                {"role": "system", "content": "–¢—ã —Å–∫–∞–ª—å–ø–µ—Ä."},
                {"role": "user", "content": system_prompt}
            ],
            extra_headers={
                "HTTP-Referer": "https://telegram.org",
                "X-Title": "CryptoBot"
            }
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–Ω–∞–π–ø–µ—Ä–∞: {str(e)}"