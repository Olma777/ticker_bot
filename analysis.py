import os
from dotenv import load_dotenv
from openai import AsyncOpenAI

load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ OpenRouter (DeepSeek V3 / Qwen / GPT-4)
client = AsyncOpenAI(
    api_key=os.getenv("OPENAI_API_KEY"),
    base_url="https://openrouter.ai/api/v1"
)

MODEL_NAME = "deepseek/deepseek-chat"

# --- 1. –ê–£–î–ò–¢ –ü–†–û–ï–ö–¢–ê (/audit) ---
async def get_crypto_analysis(ticker, full_name):
    system_prompt = f"""
    –¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –∞—É–¥–∏—Ç–æ—Ä –∫—Ä–∏–ø—Ç–æ-–ø—Ä–æ–µ–∫—Ç–æ–≤.
    –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–≤–µ—Å—Ç–∏ –∂–µ—Å—Ç–∫–∏–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –∞—É–¥–∏—Ç –ø—Ä–æ–µ–∫—Ç–∞ {full_name} ({ticker}).
    –¢—ã –¥–æ–ª–∂–µ–Ω –≤—ã—è–≤–∏—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ä–æ—Å—Ç–∞, –Ω–æ –∏ —Å–∫—Ä—ã—Ç—ã–µ —Ä–∏—Å–∫–∏, –ø—Ä–∏–∑–Ω–∞–∫–∏ —Å–∫–∞–º–∞ –∏–ª–∏ —Å–ª–∞–±—É—é —Ç–æ–∫–µ–Ω–æ–º–∏–∫—É.

    –ò–°–ü–û–õ–¨–ó–£–ô –≠–¢–û–¢ –®–ê–ë–õ–û–ù –ê–£–î–ò–¢–ê:

    1. üõ° –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –†–µ–ø—É—Ç–∞—Ü–∏—è (Scam Check):
       - –ö—Ç–æ —Å—Ç–æ–∏—Ç –∑–∞ –ø—Ä–æ–µ–∫—Ç–æ–º? (–ê–Ω–æ–Ω–∏–º—ã –∏–ª–∏ –ø—É–±–ª–∏—á–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ —Å —Ä–µ–ø—É—Ç–∞—Ü–∏–µ–π).
       - –ë—ã–ª–∏ –ª–∏ –≤–∑–ª–æ–º—ã –∏–ª–∏ –∞—É–¥–∏—Ç—ã –∫–æ–¥–∞ (Certik –∏ –¥—Ä.)?
       - –ï—Å—Ç—å –ª–∏ "Red Flags" (—Ç—Ä–µ–≤–æ–∂–Ω—ã–µ –∑–≤–æ–Ω–æ—á–∫–∏)?

    2. üíé –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å:
       - –†–µ–∞–ª—å–Ω–∞—è –ø–æ–ª—å–∑–∞ (Utility): –ö–∞–∫—É—é –ø—Ä–æ–±–ª–µ–º—É —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç?
       - –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: –ß–µ–º –æ–Ω –ª—É—á—à–µ –∞–Ω–∞–ª–æ–≥–æ–≤?
       - –≠–∫–æ—Å–∏—Å—Ç–µ–º–∞: –†–∞—Å—Ç–µ—Ç –ª–∏ TVL –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤?

    3. üìä –¢–æ–∫–µ–Ω–æ–º–∏–∫–∞ –∏ –ò–Ω—Ñ–ª—è—Ü–∏—è:
       - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤: –ù–µ—Ç –ª–∏ —á—Ä–µ–∑–º–µ—Ä–Ω–æ–π –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ —É –∫–æ–º–∞–Ω–¥—ã?
       - –í–µ—Å—Ç–∏–Ω–≥–∏: –û–∂–∏–¥–∞—é—Ç—Å—è –ª–∏ –∫—Ä—É–ø–Ω—ã–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Ä—É—à–∞—Ç —Ü–µ–Ω—É?
       - –ò–Ω—Ñ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å.

    4. üåç –ú–∞–∫—Ä–æ –∏ –†—ã–Ω–æ–∫:
       - –õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –Ω–∞ –±–∏—Ä–∂–∞—Ö.
       - –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Å —Ä—ã–Ω–∫–æ–º –∏ —Ç–µ–∫—É—â–∏–π —Ö–∞–π–ø.

    5. ‚öñÔ∏è –í–ï–†–î–ò–ö–¢ –ê–£–î–ò–¢–û–†–ê:
       - –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∏—Å–∫–∞: [–ù–∏–∑–∫–∏–π / –°—Ä–µ–¥–Ω–∏–π / –í—ã—Å–æ–∫–∏–π / –≠–ö–°–¢–†–ï–ú–ê–õ–¨–ù–´–ô].
       - –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª: (–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –≤—ã–≤–æ–¥).

    6. –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞: Markdown –¥–ª—è Telegram.
    """

    try:
        response = await client.chat.completions.create(
            model=MODEL_NAME,
            messages=[
                {"role": "system", "content": "–¢—ã —Å—Ç—Ä–æ–≥–∏–π –∫—Ä–∏–ø—Ç–æ-–∞—É–¥–∏—Ç–æ—Ä."},
                {"role": "user", "content": system_prompt}
            ],
            extra_headers={
                "HTTP-Referer": "https://telegram.org",
                "X-Title": "CryptoAuditBot"
            }
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∞—É–¥–∏—Ç–∞: {str(e)}"


# --- 2. –°–í–ò–ù–ì-–¢–†–ï–ô–î–ò–ù–ì (/sniper) ---
async def get_sniper_analysis(ticker, full_name, price):
    system_prompt = f"""
    –ü—Ä–æ–≤–µ–¥–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∏ –∞–Ω–∞–ª–∏–∑ –º–∞—Ä–∫–µ—Ç–º–µ–π–∫–µ—Ä–∞ –¥–ª—è –º–æ–Ω–µ—Ç—ã {full_name} ({ticker}) –ø—Ä–∏ —Ü–µ–Ω–µ ${price}.
    –¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–π–¥–µ—Ä (Smart Money Concepts).

    –®–ê–ë–õ–û–ù –ê–ù–ê–õ–ò–ó–ê:

    1. –ö–ª—é—á–µ–≤—ã–µ —É—Ä–æ–≤–Ω–∏ (D/W):
       - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ.

    2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä—ã–Ω–∫–∞:
       - –¢—Ä–µ–Ω–¥ –∏ –§–∞–∑–∞ (–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ/–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ).

    3. –°–ª–µ–¥—ã –ú–∞—Ä–∫–µ—Ç–º–µ–π–∫–µ—Ä–∞:
       - –õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å (–≥–¥–µ —Å—Ç–æ–ø—ã?).
       - –î–∏—Å–±–∞–ª–∞–Ω—Å (OI, Funding Rates).
       - –ú–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏.

    4. –°–ò–ì–ù–ê–õ (–°–≤–∏–Ω–≥):
       - –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: [–õ–û–ù–ì / –®–û–†–¢] (–°—Ç—Ä–æ–≥–æ –æ–¥–Ω–æ).
       - –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞.
       - –¢–µ–π–∫–∏ (3 —É—Ä–æ–≤–Ω—è).
       - –°—Ç–æ–ø-–ª–æ—Å—Å.

    5. –§–æ—Ä–º–∞—Ç: Markdown –¥–ª—è Telegram.
    """

    try:
        response = await client.chat.completions.create(
            model=MODEL_NAME,
            messages=[
                {"role": "system", "content": "–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–π–¥–µ—Ä."},
                {"role": "user", "content": system_prompt}
            ],
            extra_headers={
                "HTTP-Referer": "https://telegram.org",
                "X-Title": "CryptoSniperBot"
            }
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–Ω–∞–π–ø–µ—Ä–∞: {str(e)}"