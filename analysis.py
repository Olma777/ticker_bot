# analysis.py
import os
import re
import time
from datetime import datetime
from dotenv import load_dotenv
from openai import AsyncOpenAI

load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ (DeepSeek —á–µ—Ä–µ–∑ OpenRouter)
client = AsyncOpenAI(
    api_key=os.getenv("OPENAI_API_KEY"),
    base_url="https://openrouter.ai/api/v1"
)

MODEL_NAME = "deepseek/deepseek-chat"

# --- –ö–≠–®–ò–†–û–í–ê–ù–ò–ï ---
ANALYSIS_CACHE = {}
CACHE_TTL = 300       # 5 –º–∏–Ω—É—Ç
DAILY_CACHE_TTL = 1800 # 30 –º–∏–Ω—É—Ç

def clean_html(text):
    """
    –ù–∞–¥—ë–∂–Ω–æ –æ—á–∏—â–∞–µ—Ç HTML-–æ—Ç–≤–µ—Ç –æ—Ç AI:
    - –≠–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç <, >, &
    - –£–¥–∞–ª—è–µ—Ç markdown –∏ –∫–æ–¥-–±–ª–æ–∫–∏
    - –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç **–∂–∏—Ä–Ω—ã–π** ‚Üí <b>–∂–∏—Ä–Ω—ã–π</b>
    - –£–±–∏—Ä–∞–µ—Ç –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ —Ç–µ–≥–∏
    """
    if not text:
        return ""

    # –£–±–∏—Ä–∞–µ–º –æ–±—ë—Ä—Ç–∫–∏ –∫–æ–¥–∞
    text = re.sub(r"```.*?```", "", text, flags=re.DOTALL)
    text = re.sub(r"```\w*", "", text)

    # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –î–û –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–≥–æ–≤
    text = text.replace("&", "&amp;")
    text = text.replace("<", "&lt;")
    text = text.replace(">", "&gt;")

    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Ç–µ–≥–∏
    text = re.sub(r"&lt;b&gt;(.*?)&lt;/b&gt;", r"<b>\1</b>", text, flags=re.DOTALL)
    text = re.sub(r"&lt;i&gt;(.*?)&lt;/i&gt;", r"<i>\1</i>", text, flags=re.DOTALL)

    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º **—Ç–µ–∫—Å—Ç** ‚Üí <b>—Ç–µ–∫—Å—Ç</b>
    text = re.sub(r"\*\*(.*?)\*\*", r"<b>\1</b>", text)

    # –ó–∞–º–µ–Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    text = re.sub(r"###\s*(.*)", r"<b>\1</b>", text)
    text = re.sub(r"##\s*(.*)", r"<b>\1</b>", text)

    # –°–ø–∏—Å–∫–∏
    text = text.replace("* ", "‚Ä¢ ").replace("- ", "‚Ä¢ ")

    # –£–±–∏—Ä–∞–µ–º –æ—Å—Ç–∞—Ç–∫–∏ markdown
    text = re.sub(r"__([^_]+)__", r"<b>\1</b>", text)

    return text.strip()

# --- –°–ù–ê–ô–ü–ï–†: –°–£–ü–ï–†-–ü–†–û–ú–¢ (v2) ---
async def get_sniper_analysis(ticker, full_name, price, lang="ru"):
    cache_key = f"{ticker}_sniper_{lang}"
    if cache_key in ANALYSIS_CACHE:
        timestamp, cached_text = ANALYSIS_CACHE[cache_key]
        if time.time() - timestamp < CACHE_TTL:
            return cached_text

    system_prompt = f"""
–†–û–õ–¨: –¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π SMC-—Ç—Ä–µ–π–¥–µ—Ä –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫ –º–∞—Ä–∫–µ—Ç–º–µ–π–∫–µ—Ä—Å–∫–∏—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π (Liquidity Hunter 2.0).  
–¢–ò–ö–ï–†: {ticker}  
–ü–û–õ–ù–û–ï –ù–ê–ó–í–ê–ù–ò–ï: {full_name}  
–¢–ï–ö–£–©–ê–Ø –¶–ï–ù–ê: ${price} (—Ç–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ API ‚Äî –ù–ï –ò–ó–ú–ï–ù–Ø–¢–¨).

üéØ –ó–ê–î–ê–ß–ê:  
–°–æ–∑–¥–∞—Ç—å **—Å–Ω–∞–π–ø–µ—Ä—Å–∫–∏–π —Ñ—å—é—á–µ—Ä—Å–Ω—ã–π —Å–µ—Ç–∞–ø** —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é –≤—Ö–æ–¥–∞, –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–π –Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è—Ö –º–∞—Ä–∫–µ—Ç–º–µ–π–∫–µ—Ä–æ–≤.  
–¢—ã –¥–æ–ª–∂–µ–Ω –≥–æ–≤–æ—Ä–∏—Ç—å **—Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –º–æ–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ –∏–∑ —Ä—ã–Ω–æ—á–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –ª–æ–≥–∏–∫–∏ –ú–ú** ‚Äî –Ω–∏–∫–∞–∫–∏—Ö –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–π –±–µ–∑ –æ—Å–Ω–æ–≤–∞–Ω–∏–π.

‚ùóÔ∏è–ñ–Å–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê:
1. **–ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π –≤—Ö–æ–¥ –≤—ã—à–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã** ‚Äî —Ç–æ–ª—å–∫–æ limit-–æ—Ä–¥–µ—Ä–∞ –Ω–∏–∂–µ (–¥–ª—è LONG) –∏–ª–∏ –≤—ã—à–µ (–¥–ª—è SHORT).
2. **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –≤—ã–º—ã—à–ª–µ–Ω–Ω—ã–µ —Ü–µ–Ω—ã** ‚Äî –≤—Å–µ —É—Ä–æ–≤–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –æ—Ç ${price}.
3. **–ù–ï –¥–∞–≤–∞–π —Ç–æ—Ä–≥–æ–≤—ã–π —Å–æ–≤–µ—Ç** ‚Äî —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π, –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–≤–æ–¥.
4. **–§–æ—Ä–º–∞—Ç ‚Äî Telegram HTML**: –∏—Å–ø–æ–ª—å–∑—É–π `<b>`, `<i>`, —Å–ø–∏—Å–∫–∏ —Å `‚Ä¢`. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π markdown, –∫–æ–¥-–±–ª–æ–∫–∏ –∏–ª–∏ –Ω–µ—ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã `<`.

üß† –ê–ù–ê–õ–ò–ó –î–û–õ–ñ–ï–ù –í–ö–õ–Æ–ß–ê–¢–¨:

1. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä—ã–Ω–∫–∞ (1H/4H/Daily)**  
   ‚Ä¢ –¢—Ä–µ–Ω–¥: –≤–æ—Å—Ö–æ–¥—è—â–∏–π / –Ω–∏—Å—Ö–æ–¥—è—â–∏–π / –±–æ–∫–æ–≤–∏–∫  
   ‚Ä¢ –ö–ª—é—á–µ–≤—ã–µ –∑–æ–Ω—ã: POI (Point of Interest), Order Block, Fair Value Gap  
   ‚Ä¢ –ü–∞—Ç—Ç–µ—Ä–Ω—ã: –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è, –∫–ª–∏–Ω, —Ñ–ª–∞–≥, –¥–Ω–æ/–≤–µ—Ä—à–∏–Ω–∞

2. **–õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å & MM-–ø–æ–≤–µ–¥–µ–Ω–∏–µ (Liquidity Hunter 2.0)**  
   ‚Ä¢ –ì–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –∫–ª–∞—Å—Ç–µ—Ä—ã —Å—Ç–æ–ø-–ª–æ—Å—Å–æ–≤ (–ª–æ–Ω–≥–∏—Å—Ç–æ–≤/—à–æ—Ä—Ç–∏—Å—Ç–æ–≤)?  
   ‚Ä¢ –ë—ã–ª–∏ –ª–∏ –ª–æ–∂–Ω—ã–µ –ø—Ä–æ–±–æ–∏ –∏–ª–∏ "—Ñ–∏—Ç–∏–ª–∏" –¥–ª—è —Å–±–æ—Ä–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏?  
   ‚Ä¢ –ö–∞–∫–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –ú–ú: Accumulation, Spoofing, Volatility Provision?

3. **–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ä—ã–Ω–∫–∞**  
   ‚Ä¢ –û—Ç–∫—Ä—ã—Ç—ã–π –∏–Ω—Ç–µ—Ä–µ—Å (OI): —Ä–∞—Å—Ç—ë—Ç/–ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏–∏?  
   ‚Ä¢ Funding Rate: –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π / –ø–µ—Ä–µ—à–æ—Ä—á–µ–Ω / –ø–µ—Ä–µ–≥—Ä–µ—Ç—ã–π –ª–æ–Ω–≥?  
   ‚Ä¢ –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ Long/Short —É —Ä–∏—Ç–µ–π–ª–∞ (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)

4. **–§—É–Ω–¥–∞–º–µ–Ω—Ç (–∫—Ä–∞—Ç–∫–æ!)**  
   ‚Ä¢ –ï—Å—Ç—å –ª–∏ –±–ª–∏–∂–∞–π—à–∏–µ –∫–∞—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä—ã (–∞–ø–¥–µ–π—Ç, –ª–∏—Å—Ç–∏–Ω–≥, —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)?  
   ‚Ä¢ –†–∏—Å–∫–∏: –∫—Ä—É–ø–Ω—ã–µ vesting, —Ä–µ–≥—É–ª—è—Ç–æ—Ä–Ω—ã–µ —É–≥—Ä–æ–∑—ã?

5. **–§–¨–Æ–ß–ï–†–°–ù–´–ô –°–ò–ì–ù–ê–õ (–¢–û–õ–¨–ö–û –û–î–ù–û –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ï)**  
   –£–∫–∞–∂–∏ –ß–Å–¢–ö–û:
   üîπ **–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: LONG –∏–ª–∏ SHORT  
   üîπ **–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞**: –¥–∏–∞–ø–∞–∑–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, $X.XX ‚Äì $X.XX)  
   üîπ **TP1 / TP2 / TP3**: —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Ü–µ–ª–∏ (+5%‚Ä¶+20%)  
   üîπ **–£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ 1 / 2**: –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)  
   üîπ **–°—Ç–æ–ø-–ª–æ—Å—Å**: —É—Ä–æ–≤–µ–Ω—å, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–π –ª–æ–º–∞–µ—Ç—Å—è  
   üîπ **–¢–∞–π–º—Ñ—Ä–µ–π–º**: intraday / 1‚Äì3d / 3‚Äì7d

6. **P-Score**  
   –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è (0‚Äì100%):  
   ‚Ä¢ 80‚Äì100% ‚Äî –≤—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å  
   ‚Ä¢ 50‚Äì79% ‚Äî —Å—Ä–µ–¥–Ω—è—è, –≤–æ–∑–º–æ–∂–Ω—ã –ª–æ–≤—É—à–∫–∏  
   ‚Ä¢ <50% ‚Äî —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω–æ

7. **Liquidity Map (—Ç–µ–∫—Å—Ç–æ–≤–æ)**  
   –ö—É–¥–∞ –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ —Ü–µ–Ω–∞ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞:  
   ‚Ä¢ –í–≤–µ—Ä—Ö: –∑–æ–Ω–∞ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–π —à–æ—Ä—Ç–æ–≤  
   ‚Ä¢ –í–Ω–∏–∑: –∑–æ–Ω–∞ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–π –ª–æ–Ω–≥–æ–≤

üìå –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:  
<i>–ö—Ä–∞—Ç–∫–∞—è —Ñ—Ä–∞–∑–∞-—Ä–µ–∑—é–º–µ: –ø–æ—á–µ–º—É —Å–µ–π—á–∞—Å ‚Äî –ª—É—á—à–∏–π –º–æ–º–µ–Ω—Ç –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ —ç—Ç–æ–π –º–æ–Ω–µ—Ç–æ–π.</i>

‚ùóÔ∏è–í–ê–ñ–ù–û: –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ ‚Äî —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏: ¬´–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–Ω–∞–π–ø–µ—Ä—Å–∫–æ–≥–æ —Å–µ—Ç–∞–ø–∞¬ª. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π.
"""

    try:
        response = await client.chat.completions.create(
            model=MODEL_NAME,
            messages=[
                {"role": "system", "content": "You are a strict Smart Money trader. Use ONLY Telegram HTML tags (<b>, <i>). NEVER use markdown or unescaped <."},
                {"role": "user", "content": system_prompt}
            ],
            temperature=0.2,
            extra_headers={"HTTP-Referer": "https://telegram.org", "X-Title": "CryptoBot"}
        )
        raw_text = response.choices[0].message.content
        result = clean_html(raw_text)
        ANALYSIS_CACHE[cache_key] = (time.time(), result)
        return result
    except Exception as e:
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–Ω–∞–π–ø–µ—Ä–∞: {str(e)}"

# --- –§–£–ù–î–ê–ú–ï–ù–¢–ê–õ–¨–ù–´–ô –ê–£–î–ò–¢ (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å, –Ω–æ —Å —Ç–µ–º –∂–µ clean_html) ---
async def get_crypto_analysis(ticker, full_name, lang="ru"):
    cache_key = f"{ticker}_audit_{lang}"
    if cache_key in ANALYSIS_CACHE:
        timestamp, cached_text = ANALYSIS_CACHE[cache_key]
        if time.time() - timestamp < CACHE_TTL:
            return cached_text

    system_prompt = f"""
    –¢—ã ‚Äî Senior VC Analyst (–í–µ–Ω—á—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫).
    –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–≤–µ—Å—Ç–∏ –∂–µ—Å—Ç–∫–∏–π Due Diligence –ø—Ä–æ–µ–∫—Ç–∞ {full_name} ({ticker}).
    –°—Ç–∏–ª—å: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π, –±–µ–∑ –≤–æ–¥—ã, —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã –∏ —Ä–∏—Å–∫–∏.

    –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (Telegram HTML):
    üõ° <b>{ticker} ‚Äî –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –ê—É–¥–∏—Ç</b>

    1Ô∏è‚É£ <b>–¢–æ–∫–µ–Ω–æ–º–∏–∫–∞ –∏ –ò–Ω—Ñ–ª—è—Ü–∏—è</b>
    ‚Ä¢ <b>FDV vs Market Cap:</b> (–ï—Å—Ç—å –ª–∏ –Ω–∞–≤–µ—Å —Ç–æ–∫–µ–Ω–æ–≤?).
    ‚Ä¢ <b>–†–∞–∑–ª–æ–∫–∏ (Unlocks):</b> (–î–∞–≤—è—Ç –ª–∏ —Ñ–æ–Ω–¥—ã –Ω–∞ —Å—Ç–∞–∫–∞–Ω?).
    ‚Ä¢ <b>Utility:</b> (–†–µ–∞–ª—å–Ω–∞—è –ø–æ–ª—å–∑–∞ —Ç–æ–∫–µ–Ω–∞ –∏–ª–∏ —Ñ–∞–Ω—Ç–∏–∫?).

    2Ô∏è‚É£ <b>–ü—Ä–æ–¥—É–∫—Ç –∏ –ú–µ—Ç—Ä–∏–∫–∏</b>
    ‚Ä¢ <b>–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã:</b> (–ö—Ç–æ —Å–∏–ª—å–Ω–µ–µ –≤ –Ω–∏—à–µ?).
    ‚Ä¢ <b>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</b> (GitHub, TVL, —Ä–µ–∞–ª—å–Ω—ã–µ —é–∑–µ—Ä—ã).

    3Ô∏è‚É£ <b>–í–µ—Ä–¥–∏–∫—Ç –∏ –ü—Ä–æ–≥–Ω–æ–∑</b>
    ‚Ä¢ <b>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª:</b> (–í–∑–≥–ª—è–¥ –Ω–∞ 6-12 –º–µ—Å—è—Ü–µ–≤).
    ‚Ä¢ <b>–†–∏—Å–∫:</b> [–ù–ò–ó–ö–ò–ô / –°–†–ï–î–ù–ò–ô / –í–´–°–û–ö–ò–ô].
    """

    try:
        response = await client.chat.completions.create(
            model=MODEL_NAME,
            messages=[
                {"role": "system", "content": "You are a strict VC analyst. Use Telegram HTML tags (<b>, <i>)."},
                {"role": "user", "content": system_prompt}
            ],
            temperature=0.2,
            extra_headers={"HTTP-Referer": "https://telegram.org", "X-Title": "CryptoBot"}
        )
        result = clean_html(response.choices[0].message.content)
        ANALYSIS_CACHE[cache_key] = (time.time(), result)
        return result
    except Exception as e:
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∞—É–¥–∏—Ç–∞: {str(e)}"

# --- DAILY BRIEFING (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ clean_html) ---
async def get_daily_briefing(market_data):
    date_str = datetime.now().strftime("%d.%m.%Y")
    cache_key = f"daily_briefing_{date_str}"
    
    if cache_key in ANALYSIS_CACHE:
        timestamp, cached_text = ANALYSIS_CACHE[cache_key]
        if time.time() - timestamp < DAILY_CACHE_TTL:
            return cached_text

    top_coins_data = market_data.get('top_coins', '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö')

    system_prompt = f"""
    –†–û–õ–¨: –í–µ–¥—É—â–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –∫—Ä–∏–ø—Ç–æ-—Ñ–æ–Ω–¥–∞.
    –î–ê–¢–ê: {date_str}
    –ú–ê–ö–†–û: BTC Dom: {market_data.get('btc_dominance')}%
    
    –í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï (–¢–û–ü –ú–û–ù–ï–¢–´ –ò –ò–• –†–ï–ê–õ–¨–ù–´–ï –¶–ï–ù–´):
    {top_coins_data}

    –ó–ê–î–ê–ß–ê:
    –°–æ—Å—Ç–∞–≤—å —É—Ç—Ä–µ–Ω–Ω–∏–π –±—Ä–∏—Ñ–∏–Ω–≥ –ø–æ —ç—Ç–∏–º 3 –º–æ–Ω–µ—Ç–∞–º.
    
    ‚ùóÔ∏è –í–ê–ñ–ù–ï–ô–®–ï–ï –ü–†–ê–í–ò–õ–û:
    –¢—ã –û–ë–Ø–ó–ê–ù –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ü–µ–Ω—ã –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ –∫–∞–∫ –¢–ï–ö–£–©–ò–ï. 
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–π —Ü–µ–ª–∏ (Take Profit) –∏ —É—Ä–æ–≤–Ω–∏ –≤—Ö–æ–¥–∞ (Entry) –¢–û–õ–¨–ö–û –æ—Ç —ç—Ç–∏—Ö —Ü–µ–Ω.
    –ù–ï –ü–†–ò–î–£–ú–´–í–ê–ô –¶–ï–ù–´ –ò–ó –ì–û–õ–û–í–´.

    –§–û–†–ú–ê–¢ –í–´–í–û–î–ê (HTML):
    üåÖ <b>Market Pulse: {date_str}</b>

    üìä <b>–ú–∞–∫—Ä–æ:</b> {{BULLISH / NEUTRAL}} (BTC Dom {market_data.get('btc_dominance')}%)
    {{–ö—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ –ø–æ —Ä—ã–Ω–∫—É –≤ —Ü–µ–ª–æ–º}}.

    üî• <b>–°–µ–∫—Ç–æ—Ä –¥–Ω—è:</b> (–û–ø—Ä–µ–¥–µ–ª–∏ –æ–±—â–∏–π —Å–µ–∫—Ç–æ—Ä —ç—Ç–∏—Ö –º–æ–Ω–µ—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä AI, Gaming –∏–ª–∏ L1).

    üíé <b>Watchlist (–û—Ö–æ—Ç–∞ –∑–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å—é):</b>

    1. <b>#TICKER</b> üìà LONG (–∏–ª–∏ SHORT)
       üíµ <b>–¶–µ–Ω–∞:</b> (–í—Å—Ç–∞–≤—å —Ü–µ–Ω—É –∏–∑ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö!)
       ‚îî <i>–°–µ—Ç–∞–ø:</i> (–ù–∞–ø—Ä–∏–º–µ—Ä: –°–±–æ—Ä –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ / –¢–µ—Å—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏).
       ‚îî <i>–ü–ª–∞–Ω:</i> –ñ–¥–µ–º (–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞ —Ä—è–¥–æ–º —Å —Ç–µ–∫—É—â–µ–π). –¶–µ–ª—å (–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è, +5-15%).

    2. <b>#TICKER</b> ...
       ...

    3. <b>#TICKER</b> ...
       ...
    
    üëá <i>–î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å–¥–µ–ª–∫–∏: /sniper [—Ç–∏–∫–µ—Ä]</i>
    """

    try:
        response = await client.chat.completions.create(
            model=MODEL_NAME,
            messages=[
                {"role": "system", "content": "You are a strict crypto analyst. Do not hallucinate prices. Use ONLY provided input data."},
                {"role": "user", "content": system_prompt}
            ],
            temperature=0.2,
            extra_headers={"HTTP-Referer": "https://telegram.org", "X-Title": "CryptoBot"}
        )
        result = clean_html(response.choices[0].message.content)
        ANALYSIS_CACHE[cache_key] = (time.time(), result)
        return result
    except Exception as e:
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –±—Ä–∏—Ñ–∏–Ω–≥–∞: {str(e)}"