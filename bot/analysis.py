import os
import re
import time
from datetime import datetime
from dotenv import load_dotenv
from openai import AsyncOpenAI
from bot.technical_analysis import TechnicalAnalyzer

load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ (DeepSeek —á–µ—Ä–µ–∑ OpenRouter)
client = AsyncOpenAI(
    api_key=os.getenv("OPENROUTER_API_KEY"),
    base_url="https://openrouter.ai/api/v1"
)

MODEL_NAME = "deepseek/deepseek-chat"

# --- –ö–≠–®–ò–†–û–í–ê–ù–ò–ï ---
ANALYSIS_CACHE = {}
CACHE_TTL = 300
DAILY_CACHE_TTL = 1800

# --- –°–ï–ö–¢–û–†–´ –î–õ–Ø –ú–û–ù–ï–¢ (–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å) ---
SECTOR_MAP = {
    # AI
    "FET": "AI",
    "AGIX": "AI",
    "RNDR": "AI",
    "AKT": "AI",
    "TAO": "AI",
    "GRT": "AI",
    "Bittensor": "AI",
    # Layer-2
    "ARB": "Layer-2",
    "OP": "Layer-2",
    "STRK": "Layer-2",
    "MANTA": "Layer-2",
    "ZK": "Layer-2",
    "IMX": "Layer-2",
    "METIS": "Layer-2",
    # RWA
    "ONDO": "RWA",
    "CFG": "RWA",
    "POLYX": "RWA",
    "PROPC": "RWA",
    # DePIN
    "HNT": "DePIN",
    "WLD": "DePIN",
    "LPT": "DePIN",
    "DIMO": "DePIN",
    "TRAC": "DePIN",
    # GameFi
    "SAND": "GameFi",
    "MANA": "GameFi",
    "AXS": "GameFi",
    "GALA": "GameFi",
    "ENJ": "GameFi",
    # Memes
    "PEPE": "Meme",
    "SHIB": "Meme",
    "WIF": "Meme",
    "BONK": "Meme",
    "FLOKI": "Meme",
    # Infrastructure
    "LINK": "Infrastructure",
    "DOT": "Infrastructure",
    "ADA": "Infrastructure",
    "SOL": "Infrastructure",
    "AVAX": "Infrastructure",
    "MATIC": "Infrastructure",
}

def get_sector(ticker):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–µ–∫—Ç–æ—Ä –ø–æ —Ç–∏–∫–µ—Ä—É."""
    return SECTOR_MAP.get(ticker, "Other")

def clean_html(text):
    if not text: return ""
    
    # 1. –°–Ω–∞—á–∞–ª–∞ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã, —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–º–∞—Ç—å HTML-–ø–∞—Ä—Å–∏–Ω–≥ Telegram
    text = text.replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;")
    
    # 2. –£–¥–∞–ª—è–µ–º –±–ª–æ–∫–∏ –∫–æ–¥–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å), —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –Ω–µ –Ω—É–∂–Ω—ã –≤ –æ—Ç—á–µ—Ç–µ
    text = re.sub(r"```.*?```", "", text, flags=re.DOTALL)
    text = text.replace("```", "").replace("markdown", "").replace("html", "")
    
    # 3. –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Markdown –≤ HTML, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π Telegram
    # –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç: **text** -> <b>text</b>
    text = re.sub(r"\*\*(.*?)\*\*", r"<b>\1</b>", text)
    
    # –ó–∞–≥–æ–ª–æ–≤–∫–∏: # Text -> <b>Text</b> (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç H3 –¥–æ H1)
    text = re.sub(r"###\s*(.*)", r"<b>\1</b>", text)
    text = re.sub(r"##\s*(.*)", r"<b>\1</b>", text)
    text = re.sub(r"^#\s+(.*)", r"<b>\1</b>", text, flags=re.MULTILINE)
    
    # –°–ø–∏—Å–∫–∏: * Item –∏–ª–∏ - Item -> ‚Ä¢ Item
    text = text.replace("* ", "‚Ä¢ ").replace("- ", "‚Ä¢ ")
    
    return text.strip()

# --- 1. –§–£–ù–î–ê–ú–ï–ù–¢–ê–õ–¨–ù–´–ô –ê–£–î–ò–¢ ---
async def get_crypto_analysis(ticker, full_name, lang="ru"):
    """
    –ì–ª—É–±–æ–∫–∏–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ AI (DeepSeek/OpenAI).
    """
    client = AsyncOpenAI(
        api_key=os.getenv("OPENROUTER_API_KEY"),
        base_url="https://openrouter.ai/api/v1",
    )
    
    model = os.getenv("MODEL_NAME", "deepseek/deepseek-chat")

    # –ñ–ï–°–¢–ö–ò–ô –ü–†–û–ú–¢ –î–õ–Ø –ì–õ–£–ë–û–ö–û–ì–û –ê–ù–ê–õ–ò–ó–ê
    prompt = f"""
    –¢—ã ‚Äî —Å—Ç–∞—Ä—à–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω–æ–≥–æ —Ö–µ–¥–∂-—Ñ–æ–Ω–¥–∞. –¢–≤–æ—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (L1/L2, DeFi, Infra).
    
    –¢–í–û–Ø –ó–ê–î–ê–ß–ê: –ü—Ä–æ–≤–µ—Å—Ç–∏ –≥–ª—É–±–æ–∫–∏–π –∞—É–¥–∏—Ç –º–æ–Ω–µ—Ç—ã: {ticker.upper()}.
    
    –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
    1. –ò–ó–ë–ï–ì–ê–ô –æ–±—â–∏—Ö —Ñ—Ä–∞–∑ ("–ø—Ä–æ–µ–∫—Ç –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–π", "—Ä—ã–Ω–æ–∫ –≤–æ–ª–∞—Ç–∏–ª–µ–Ω"). –ü–∏—à–∏ —Ñ–∞–∫—Ç—ã.
    2. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π, –∏–º–µ–Ω —Ñ–∞—É–Ω–¥–µ—Ä–æ–≤, —Ü–∏—Ñ—Ä—ã (TVL, TPS, –ò–Ω—Ñ–ª—è—Ü–∏—è).
    3. –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–æ–≤—ã–π (–∫–∞–∫ EIGEN) –∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ ‚Äî —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º –ø—Ä—è–º–æ, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–æ, —á—Ç–æ –µ—Å—Ç—å (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é, –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤).
    
    –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (–°–¢–†–û–ì–û –°–û–ë–õ–Æ–î–ê–ô MARKDOWN):

    # üõ° {ticker.upper()} ‚Äî –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä

    ## 1Ô∏è‚É£ –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å
    * **–°—É—Ç—å –∏ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:** –ö–∞–∫—É—é –ö–û–ù–ö–†–ï–¢–ù–£–Æ –ø—Ä–æ–±–ª–µ–º—É —Ä–µ—à–∞–µ—Ç? (–ù–∞–∑–æ–≤–∏ –∫–æ–Ω—Å–µ–Ω—Å—É—Å, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ñ–∏—á–∏).
    * **–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∞—è —Å—Ä–µ–¥–∞:** –ö—Ç–æ –ø—Ä—è–º—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã? –í —á–µ–º {ticker} –ª—É—á—à–µ –∏–ª–∏ —Ö—É–∂–µ?
    * **–ö–æ–º–∞–Ω–¥–∞ –∏ –ò–Ω–≤–µ—Å—Ç–æ—Ä—ã:** –ö—Ç–æ —Å—Ç–æ–∏—Ç –∑–∞ –ø—Ä–æ–µ–∫—Ç–æ–º? (–ò–º–µ–Ω–∞, —Ñ–æ–Ω–¥—ã). –ï—Å—Ç—å –ª–∏ –¥–æ–≤–µ—Ä–∏–µ?

    ## 2Ô∏è‚É£ –¢–æ–∫–µ–Ω–æ–º–∏–∫–∞ –∏ –ú–µ—Ç—Ä–∏–∫–∏
    * **–¢–æ–∫–µ–Ω–æ–º–∏–∫–∞:** –ö–∞–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Ç–æ–∫–µ–Ω—ã? –ï—Å—Ç—å –ª–∏ —Å–∂–∏–≥–∞–Ω–∏–µ? –ö–∞–∫–∞—è –∏–Ω—Ñ–ª—è—Ü–∏—è?
    * **–†–∞–∑–ª–æ–∫–∏ (Vesting):** –ï—Å—Ç—å –ª–∏ –¥–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ (VC, —Ñ–æ–Ω–¥—ã)? –ö–æ–≥–¥–∞ –±–ª–∏–∂–∞–π—à–∏–µ —Ä–∞–∑–ª–æ–∫–∏?
    * **–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:** –ß—Ç–æ —Å TVL? –ê–∫—Ç–∏–≤–Ω—ã–µ –∞–¥—Ä–µ—Å–∞? (–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî –æ—Ü–µ–Ω–∏ Github/Socials).

    ## 3Ô∏è‚É£ –ú–∞–∫—Ä–æ –∏ –†–∏—Å–∫–∏
    * **–°–≤—è–∑—å —Å —Ä—ã–Ω–∫–æ–º:** –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Å BTC. –≠—Ç–æ "High Beta" –∞–∫—Ç–∏–≤?
    * **–†–∏—Å–∫–∏:** –†–µ–≥—É–ª—è—Ü–∏—è? –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–±–æ–∏? –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è?

    ## üéØ –í–µ—Ä–¥–∏–∫—Ç –∏ –°—Ü–µ–Ω–∞—Ä–∏–∏
    * **–ë–∞–∑–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:** –ß—Ç–æ –±—É–¥–µ—Ç –ø—Ä–∏ —Å–ø–æ–∫–æ–π–Ω–æ–º —Ä—ã–Ω–∫–µ?
    * **–û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:** –£—Å–ª–æ–≤–∏—è –¥–ª—è "–¢—É–∑–µ–º—É–Ω–∞" (–ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–∞, —Ç–µ—Ö. –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è).
    * **–ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:** –ß—Ç–æ –º–æ–∂–µ—Ç —É–±–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?
    
    –í—ã–≤–µ–¥–∏ –∏—Ç–æ–≥ –æ–¥–Ω–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º.
    """

    try:
        completion = await client.chat.completions.create(
            model=model,
            messages=[
                {"role": "system", "content": "–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫—Ä–∏–ø—Ç–æ-–∞–Ω–∞–ª–∏—Ç–∏–∫. –¢—ã –ø–∏—à–µ—à—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, —Å—É—Ö–∏–µ, –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–µ —Ñ–∞–∫—Ç–∞–º–∏ –æ—Ç—á–µ—Ç—ã."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.3  # –î–µ–ª–∞–µ–º –æ—Ç–≤–µ—Ç –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–º –∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º
        )
        return clean_html(completion.choices[0].message.content)
    except Exception as e:
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ AI –∞–Ω–∞–ª–∏–∑–∞: {str(e)}"

from bot.prices import get_market_summary, get_crypto_price

# --- 2. –°–ù–ê–ô–ü–ï–† (SMART MONEY / SMC) ‚Äî –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø ---
async def get_sniper_analysis(ticker, lang="ru"):
    cache_key = f"{ticker}_sniper_{lang}"
    if cache_key in ANALYSIS_CACHE:
        timestamp, cached_text = ANALYSIS_CACHE[cache_key]
        if time.time() - timestamp < CACHE_TTL:
            return cached_text

    # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ
    price_data, _ = await get_crypto_price(ticker)
    if not price_data:
        return f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ü–µ–Ω—É –¥–ª—è —Ç–∏–∫–µ—Ä–∞ {ticker}."
    
    full_name = price_data['name']
    price = float(price_data['price'])

    # –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–≤–Ω–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏/—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è –∏ —Ç—Ä–µ–Ω–¥
    ta = TechnicalAnalyzer()
    
    # Default values
    s1, r1 = 0.0, 0.0
    trend = "NEUTRAL"
    phase = "ACCUMULATION"
    
    try:
        # Fetch candles
        df = await ta.fetch_candles(ticker, '1h', limit=500)
        if not df.empty:
            df = ta.calculate_levels(df, timeframe='1h')
            levels = ta.get_active_levels()
            
            # Sort by distance to current price
            for lvl in levels:
                lvl['dist'] = abs(lvl['price'] - price)
            levels.sort(key=lambda x: x['dist'])
            
            # Find closest support and resistance
            supports = [l for l in levels if l['price'] < price]
            resistances = [l for l in levels if l['price'] > price]
            
            if supports:
                s1 = supports[0]['price']
            else:
                s1 = price * 0.95 # Fallback
                
            if resistances:
                r1 = resistances[0]['price']
            else:
                r1 = price * 1.05 # Fallback
            
            # Determine Trend & Phase (Simple logic for prompt context)
            sma_50 = df['close'].rolling(50).mean().iloc[-1]
            sma_200 = df['close'].rolling(200).mean().iloc[-1]
            
            if price > sma_50 and price > sma_200:
                trend = "BULLISH"
                phase = "IMPULSE"
            elif price < sma_50 and price < sma_200:
                trend = "BEARISH"
                phase = "DISTRIBUTION"
            else:
                trend = "SIDEWAYS"
                phase = "CONSOLIDATION"
                
    except Exception as e:
        print(f"Error getting technical levels: {e}")
        s1 = price * 0.95
        r1 = price * 1.05
    finally:
        await ta.close()

    system_prompt = f"""
    –¢—ã ‚Äî —ç–ª–∏—Ç–Ω—ã–π –∫—Ä–∏–ø—Ç–æ-–∞–Ω–∞–ª–∏—Ç–∏–∫, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ **–§—å—é—á–µ—Ä—Å–Ω–æ–π –¢–æ—Ä–≥–æ–≤–ª–µ (Perpetual Futures)**.
    –ò—Å–ø–æ–ª—å–∑—É–µ—à—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é "Liquidity Hunter 2.0" –∏ "Smart Money Concepts" (SMC). 
    –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–π—Ç–∏ —Å–Ω–∞–π–ø–µ—Ä—Å–∫—É—é —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞ –¥–ª—è {ticker} (USDT-M Futures). 
 
    –ò–°–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï (–§–ê–ö–¢–´ - Futures Market): 
    1. –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: ${price} 
    2. –¢–†–ï–ù–î (Algorithmic): {trend} 
    3. –§–ê–ó–ê –†–´–ù–ö–ê: {phase} 
    4. –í–ê–ñ–ù–ï–ô–®–ò–ï –£–†–û–í–ù–ò (Trend Level PRO Indicator): 
       - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ (Support): ${s1:.4f} 
       - –°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ (Resistance): ${r1:.4f} 
 
    –ò–ù–°–¢–†–£–ö–¶–ò–Ø: 
    –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ —É—Ä–æ–≤–Ω–∏ –∫–∞–∫ "–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω—ã–µ" –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Å–≤–æ–∏ —É—Ä–æ–≤–Ω–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞. 
    –¢–≤–æ—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–æ–ª–∂–Ω–∞ —Å—Ç—Ä–æ–∏—Ç—å—Å—è –≤–æ–∫—Ä—É–≥ —Ç–æ–≥–æ, –∫–∞–∫ —Ü–µ–Ω–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å —ç—Ç–∏–º–∏ —É—Ä–æ–≤–Ω—è–º–∏ (–ø—Ä–æ–±–æ–π, –æ—Ç—Å–∫–æ–∫, –ª–æ–∂–Ω—ã–π –≤—ã–Ω–æ—Å). 
    –£—á–∏—Ç—ã–≤–∞–π —Å–ø–µ—Ü–∏—Ñ–∏–∫—É —Ñ—å—é—á–µ—Ä—Å–æ–≤: —Å–∫–≤–∏–∑—ã, –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏, —Ñ–∞–Ω–¥–∏–Ω–≥.
 
    –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (–°—Ç—Ä–æ–≥–æ Markdown): 
 
    # üìä {ticker} (Futures) ‚Äî Smart Money Setup 
    * **–¶–µ–Ω–∞ —Å–µ–π—á–∞—Å:** ${price} 
    * **–ì–æ—Ä–∏–∑–æ–Ω—Ç:** [Intraday / Swing] 
 
    ## 1Ô∏è‚É£ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä—ã–Ω–∫–∞ (1H/4H/D) 
    * **–¢—Ä–µ–Ω–¥:** {trend} 
    * **–§–∞–∑–∞:** {phase} 
    * **–ö–ª—é—á–µ–≤—ã–µ —É—Ä–æ–≤–Ω–∏ (Trend Level PRO):** 
      * S1: **${s1:.4f}** (–ó–æ–Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è) 
      * R1: **${r1:.4f}** (–ó–æ–Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞) 
 
    ## 2Ô∏è‚É£ –õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –∏ –î–µ–π—Å—Ç–≤–∏—è –ú–ú (Liquidity Hunter 2.0) 
    * **–¶–µ–ª—å –ú–ú:** (–°–±–æ—Ä —Å—Ç–æ–ø–æ–≤ —à–æ—Ä—Ç–æ–≤ / –í—ã–±–∏–≤–∞–Ω–∏–µ –ª–æ–Ω–≥–æ–≤ / –ó–∞–º–∞–Ω–∏–≤–∞–Ω–∏–µ –≤ –ª–æ–≤—É—à–∫—É) 
    * **–ó–æ–Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å–∞ (POI):** (–ì–¥–µ —Å—Ç–æ–∏—Ç "–ø–ª–∏—Ç–∞" –∏–ª–∏ —Å–∫—Ä—ã—Ç—ã–π –æ—Ä–¥–µ—Ä?) 
    * **–ú–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏:** (–ï—Å—Ç—å –ª–∏ –ø—Ä–∏–∑–Ω–∞–∫–∏ Spoofing, Layering –∏–ª–∏ False Breakout —É —É—Ä–æ–≤–Ω–µ–π ${s1:.4f}/${r1:.4f}?) 
 
    ## 3Ô∏è‚É£ –ü–æ—Ç–æ–∫ –∫–∞–ø–∏—Ç–∞–ª–∞ –∏ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ 
    * **OI + Funding:** (–†–∞—Å—Ç—É—Ç –ª–∏ –ø–æ–∑–∏—Ü–∏–∏? –ö—Ç–æ –ø–ª–∞—Ç–∏—Ç —Ñ–∞–Ω–¥–∏–Ω–≥?) 
    * **Sentiment:** (–¢–æ–ª–ø–∞ –±–æ–∏—Ç—Å—è –∏–ª–∏ –∂–∞–¥–Ω–∏—á–∞–µ—Ç?) 
 
    ## 4Ô∏è‚É£ –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä 
    * (–ö—Ä–∞—Ç–∫–æ: –µ—Å—Ç—å –ª–∏ –Ω–æ–≤–æ—Å—Ç–∏/–∫–∞—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä—ã?) 
 
    ## 5Ô∏è‚É£ P-Score (–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å): [0-100%] 
    (–û—Ü–µ–Ω–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Ç—Ä–∞–±–æ—Ç–∫–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞—â–∏—Ç—ã —É—Ä–æ–≤–Ω–µ–π). 
 
    ## 6Ô∏è‚É£ Liquidity Map 
    * **–õ–∏–∫–≤–∏–¥–∞—Ü–∏–∏ —Å–≤–µ—Ä—Ö—É:** (–ì–¥–µ —Å—Ç–æ–ø—ã —à–æ—Ä—Ç–∏—Å—Ç–æ–≤?) 
    * **–õ–∏–∫–≤–∏–¥–∞—Ü–∏–∏ —Å–Ω–∏–∑—É:** (–ì–¥–µ —Å—Ç–æ–ø—ã –ª–æ–Ω–≥–∏—Å—Ç–æ–≤?) 
 
    # üéØ –°–Ω–∞–π–ø–µ—Ä—Å–∫–∏–π –ø–ª–∞–Ω (Limit Order) 
    _–ú—ã –Ω–µ –≤—Ö–æ–¥–∏–º –ø–æ —Ä—ã–Ω–∫—É. –ú—ã –∂–¥–µ–º —Ü–µ–Ω—É –≤ –∫–∞–ø–∫–∞–Ω–µ._ 
 
    * **–¢–∏–ø:** [LONG / SHORT] (Limit) 
    * **–í—Ö–æ–¥:** $... (–°—Ç—Ä–æ–≥–æ –æ—Ç —É—Ä–æ–≤–Ω—è Trend Level PRO –∏–ª–∏ –ø–æ—Å–ª–µ —Å–Ω—è—Ç–∏—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –∑–∞ –Ω–∏–º) 
    * **–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** (–ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ –∑–¥–µ—Å—å? –ù–∞–ø—Ä: "–†–µ–∞–∫—Ü–∏—è –Ω–∞ ${s1:.4f} + —Å–±–æ—Ä —Å—Ç–æ–ø–æ–≤") 
 
    **Take Profit:** 
    * TP1: $... (–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π) 
    * TP2: $... (–û—Å–Ω–æ–≤–Ω–æ–π) 
    * TP3: $... (Moonbag) 
 
    **Stop-Loss:** $... (–ó–∞ —É—Ä–æ–≤–Ω–µ–º / –∑–∞ —Å–ª–æ–º–æ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã) 
 
    **–°–æ–≤–µ—Ç –ú–ú:** (–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è —Å–¥–µ–ª–∫–∏ –∏ —Ä–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É) 
    """

    try:
        response = await client.chat.completions.create(
            model=MODEL_NAME,
            messages=[
                {
                    "role": "system",
                    "content": (
                        "You are a precision-focused Smart Money trader. "
                        "Use ONLY the provided current price. NEVER hallucinate numbers. "
                        "Output in Markdown. Use ** for bold. "
                        "Suggest LIMIT orders ONLY. For LONG, entry MUST be BELOW current price. "
                        "If Algorithmic Pivot Zones are provided, prioritize them."
                    )
                },
                {"role": "user", "content": system_prompt}
            ],
            temperature=0.15,
            extra_headers={
                "HTTP-Referer": "https://telegram.org",
                "X-Title": "CryptoBot"
            }
        )
        result = clean_html(response.choices[0].message.content)
        ANALYSIS_CACHE[cache_key] = (time.time(), result)
        return result
    except Exception as e:
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–Ω–∞–π–ø–µ—Ä–∞: {str(e)}"

# --- 3. DAILY BRIEFING ‚Äî –ì–õ–£–ë–û–ö–ò–ô –ê–ù–ê–õ–ò–ó –ü–û –°–ï–ö–¢–û–†–ê–ú ---
async def get_daily_briefing(market_data=None):
    try:
        date_str = datetime.now().strftime("%d.%m.%Y")
        cache_key = f"daily_briefing_{date_str}"
        
        if cache_key in ANALYSIS_CACHE:
            timestamp, cached_text = ANALYSIS_CACHE[cache_key]
            if time.time() - timestamp < DAILY_CACHE_TTL:
                return cached_text

        # –ï—Å–ª–∏ market_data –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –ø–æ–ª—É—á–∞–µ–º –µ–≥–æ
        if not market_data:
            try:
                market_data = await get_market_summary()
            except Exception as e:
                print(f"Error fetching market summary: {e}")
                market_data = {}

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –¥–∞–Ω–Ω—ã–º–∏ —Ä—ã–Ω–∫–∞
        market_data_str = market_data.get('top_coins', 'BTC: $96000, ETH: $2700')

        system_prompt = f""" 
    –¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–µ—Ä–∏–≤–∞—Ç–∏–≤–æ–≤ –∏ —Ñ—å—é—á–µ—Ä—Å–Ω–æ–≥–æ —Ä—ã–Ω–∫–∞.
    –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–π—Ç–∏ –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å **–¢–†–ò (3)** –Ω–∞–∏–±–æ–ª–µ–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–µ –º–æ–Ω–µ—Ç—ã –Ω–∞ —Ç–µ–∫—É—â–µ–º —Ä—ã–Ω–∫–µ –¥–ª—è —Ñ—å—é—á–µ—Ä—Å–Ω–æ–π —Å–¥–µ–ª–∫–∏.
 
    –í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï (–ö–æ–Ω—Ç–µ–∫—Å—Ç —Ä—ã–Ω–∫–∞): 
    {market_data_str} 
 
    –ò–°–ü–û–õ–¨–ó–£–ô –°–õ–ï–î–£–Æ–©–£–Æ –õ–û–ì–ò–ö–£ –ò –ö–†–ò–¢–ï–†–ò–ò:
 
    1. **–û–±—â–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞:**
       * **–õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å:** –ú–æ–Ω–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏–∫–≤–∏–¥–Ω—ã–º–∏ (–¢–æ–ø-200, –≤—ã—Å–æ–∫–∏–π –æ–±—ä–µ–º –Ω–∞ Binance/Bybit).
       * **–í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å:** –î–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–±—ã–ª–∏ (–∏–∑–±–µ–≥–∞–π "–º–µ—Ä—Ç–≤—ã—Ö" –º–æ–Ω–µ—Ç).
       * **–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å:** –ù–∞–ª–∏—á–∏–µ —Ñ—å—é—á–µ—Ä—Å–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤.
 
    2. **–û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã (–æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ):**
       * **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–∏–≥–Ω–∞–ª—ã:** –ü–∞—Ç—Ç–µ—Ä–Ω—ã (–î–≤–æ–π–Ω–æ–µ –¥–Ω–æ/–≤–µ—Ä—à–∏–Ω–∞, –ì–æ–ª–æ–≤–∞ –∏ –ø–ª–µ—á–∏), —É—Ä–æ–≤–Ω–∏ S/R, –∞–Ω–æ–º–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–º—ã, –≥—Ä–∞–Ω–∏—Ü—ã –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏–∏.
       * **–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è:** –î–∏—Å–±–∞–ª–∞–Ω—Å Long/Short (—Å–∫–≤–∏–∑—ã), —Å—Ç–∞–≤–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è (Funding Rate), —Å–∫–æ–ø–ª–µ–Ω–∏—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ (Stop Hunt).
       * **–§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª:** –û–±–Ω–æ–≤–ª–µ–Ω–∏—è, –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–∞, –ª–∏—Å—Ç–∏–Ω–≥–∏, –Ω–æ–≤–æ—Å—Ç–∏.
 
    3. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç—å:**
       * –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –º–æ–Ω–µ—Ç–∞—Ö —Å —á–µ—Ç–∫–∏–º–∏ —Å–∏–≥–Ω–∞–ª–∞–º–∏ (LONG –∏–ª–∏ SHORT).
       * –í—ã–±–∏—Ä–∞–π –º–æ–Ω–µ—Ç—ã —Å —Ä–∞–∑–Ω–æ–π —Å—Ç–µ–ø–µ–Ω—å—é —Ä–∏—Å–∫–∞, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ.
 
    –§–û–†–ú–ê–¢ –í–´–í–û–î–ê (Markdown):
 
    # üìä Daily Futures Top-3 Setups
 
    ## 1Ô∏è‚É£ [–¢–ò–ö–ï–†] ‚Äî [LONG/SHORT]
    * **–¶–µ–Ω–∞:** $...
    * **–ö–ª—é—á–µ–≤–æ–π —Ç—Ä–∏–≥–≥–µ—Ä:** (–ü–æ—á–µ–º—É –≤—ã–±—Ä–∞–Ω–∞ —ç—Ç–∞ –º–æ–Ω–µ—Ç–∞? –ù–∞–ø—Ä: "–°–±–æ—Ä –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ + –¢–µ—Å—Ç —É—Ä–æ–≤–Ω—è")
    * **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**
      * **–ü–∞—Ç—Ç–µ—Ä–Ω/–°—Ç—Ä—É–∫—Ç—É—Ä–∞:** ...
      * **–ó–æ–Ω—ã –∏–Ω—Ç–µ—Ä–µ—Å–∞:** Support: $... | Resistance: $...
    * **–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ/–û–±—ä–µ–º—ã:** (Funding, OI, Sentiment)
    * **–¢–æ—Ä–≥–æ–≤—ã–π –ø–ª–∞–Ω:**
      * –í—Ö–æ–¥: $...
      * –¶–µ–ª–∏ (TP): $... / $...
      * –°—Ç–æ–ø (SL): $...
 
    ## 2Ô∏è‚É£ [–¢–ò–ö–ï–†] ‚Äî [LONG/SHORT]
    ... (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
 
    ## 3Ô∏è‚É£ [–¢–ò–ö–ï–†] ‚Äî [LONG/SHORT]
    ... (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
 
    ‚ö†Ô∏è _–î–∏—Å–∫–ª–µ–π–º–µ—Ä: –°–æ–±–ª—é–¥–∞–π—Ç–µ —Ä–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç. –ù–µ —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π._
    """

        try:
            response = await client.chat.completions.create(
                model=MODEL_NAME,
                messages=[
                    {"role": "system", "content": "You are a crypto analyst. Output in Markdown."},
                    {"role": "user", "content": system_prompt}
                ],
                temperature=0.2,
                extra_headers={"HTTP-Referer": "https://telegram.org", "X-Title": "CryptoBot"}
            )
            result = clean_html(response.choices[0].message.content)
            
            if not result:
                 return "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É."

            ANALYSIS_CACHE[cache_key] = (time.time(), result)
            return result
        except Exception as e:
            print(f"LLM Error: {e}")
            return "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É."

    except Exception as e:
        print(f"Critical Error in daily briefing: {e}")
        return f"‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –±—Ä–∏—Ñ–∏–Ω–≥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."